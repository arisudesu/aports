# Contributor:
pkgname=opencloud
pkgver=3.3.0
pkgrel=0
pkgdesc="Secure and private way to store, access, and share your files"
url="https://opencloud.eu/"
license="Apache-2.0"
arch="all"
makedepends="bash curl go pnpm"
subpackages="$pkgname-openrc"
pkgusers="$pkgname"
pkggroups="$pkgname"
install="$pkgname.pre-install"
options="net !check"
source="https://github.com/opencloud-eu/opencloud/archive/v$pkgver/opencloud-$pkgver.tar.gz
	$pkgname.initd
	$pkgname.confd
	build.patch
	getrelease.go
	"

export GOFLAGS="$GOFLAGS -trimpath -mod=readonly -modcacherw"
export GOCACHE="${GOCACHE:-"$srcdir/go-cache"}"
export GOTMPDIR="${GOTMPDIR:-"$srcdir"}"
export GOMODCACHE="${GOMODCACHE:-"$srcdir/go"}"

prepare() {
	default_prepare

	# go env -w GOTOOLCHAIN="$(go -C "$srcdir" run getrelease.go go1.24.)"

	sed -i 's|^\(\tLatestTag\) = .*|\1 = "'$pkgver'"|' pkg/version/version.go
}

build() {
	make generate
	make -C opencloud build
}

package() {
	install -Dm755 "$builddir"/opencloud/bin/opencloud -t "$pkgdir"/usr/bin/

	mkdir -p "$pkgdir"/etc/opencloud
	chown $pkgusers:$pkggroups "$pkgdir"/etc/opencloud
	chmod 700 "$pkgdir"/etc/opencloud
	
	install -Dm755 "$srcdir"/$pkgname.initd "$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd "$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="
3a974b45ba386539c8885885ad2b538506b68a03359dfffee8d83c6c57062d5203c2f619827b9b839fd248749d7d5a6ea894e0255fd88b4e9f449b7012c7146f  opencloud-3.3.0.tar.gz
18cd300e49c9aaffd23594e9508aa5cf90224fc4fbcd0176fc04137fdad311a492c10806fd709422c86fdedc5901eb3ac34185cf266788329d6126e3b699bccd  opencloud.initd
068eb5f72a55ae46fbfaf930985c8cef8e40eaef4e6455aa07cc2d02bfb79ad3847d517dfe69edda82b7fb744368919de32216067637ee2faa949d3ed73636da  opencloud.confd
3354d3ba30d293a71f780517befe4a35320f00db4f6e8f0bfdca4a203e82a1af68d838f7bcab7e58cf3829b5dc7426059461e3a4eb0361c7bf128fa860711f02  build.patch
9454ca0b7573fb1e185c2e2b0b2bbc91b2cd6f6a42422abe339967cfe8fafa8039a9461920bd446cb20e50d03734d851387badb1713c0cc8d3ddd6abe820f711  getrelease.go
"
