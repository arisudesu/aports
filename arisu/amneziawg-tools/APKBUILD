# Contributor:
# Maintainer:
pkgname=amneziawg-tools
pkgver=1.0.20250706
pkgrel=0
pkgdesc="A contemporary version of the popular VPN protocol, WireGuard: userspace tools"
arch="all"
url="https://amnezia.org"
# SPDX identifier headers tells us 'GPL-2.0' but considering it
# is a kernel project i think it is safe to assume it is GPL-2.0-only just
# like the kernel.
license="GPL-2.0-only"
_awg_quick_deps="
	bash
	cmd:resolvconf
	iproute2
	"
makedepends="libmnl-dev $_awg_quick_deps"
depends="$pkgname-awg $pkgname-awg-quick"
install="$pkgname-openrc.post-install"
subpackages="
	$pkgname-doc
	$pkgname-bash-completion
	$pkgname-awg:_split
	$pkgname-awg-quick:_split:noarch
	$pkgname-openrc
	"
options="!check"
source="
	amneziawg-tools-$pkgver.tar.gz::https://github.com/amnezia-vpn/amneziawg-tools/archive/refs/tags/v$pkgver.tar.gz
	awg-quick.initd
	wg-quick-different-sudo.patch
	"

build() {
	make -C src
}

package() {
	mkdir -p "$pkgdir/usr/share/doc/$pkgname"

	make -C src \
		DESTDIR="$pkgdir" \
		WITH_BASHCOMPLETION=yes \
		WITH_WGQUICK=yes \
		WITH_SYSTEMDUNITS=no \
		install

	find "$builddir"/contrib -name '.gitignore' -delete
	cp -rf "$builddir"/contrib "$pkgdir/usr/share/doc/$pkgname/"

	install -Dm755 "$srcdir"/awg-quick.initd "$pkgdir"/etc/init.d/awg-quick
}

_split() {
	local cmd=${subpkgname/$pkgname-}
	pkgdesc="$pkgdesc ($cmd)"
	case $cmd in
		awg-quick) depends="$pkgname-awg=$pkgver-r$pkgrel $_awg_quick_deps" ;;
		*) depends= ;;
	esac
	mkdir -p "$subpkgdir"/usr/bin
	mv "$pkgdir"/usr/bin/$cmd "$subpkgdir"/usr/bin/
}

sha512sums="
556ae1547e69c98188cd16870c53219bc56e6e9dcd8cf8a95e9dd4e3cfa3d3894aaad5d33e5c30fea8da041b25aa465036409840fbce34fde8922bcc05d18561  amneziawg-tools-1.0.20250706.tar.gz
f392e7dd8446e9a2dca09b0c1156db0cc0cadb3be08802b70e80b2e1d88aa85bb5a496c390bbea2d12be86db30312ba6919a1325352716271c927008b620e2d8  awg-quick.initd
bf623fa31215d2e90078950dc18b9e69004235aa2e87cc4910ce710ba51119fb76c345a9cce1d0aa946fad1ccb5a40e9734ff3424e8d2d16cd00c1f1e0fe4916  wg-quick-different-sudo.patch
"
